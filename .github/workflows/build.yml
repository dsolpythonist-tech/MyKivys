name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  build:
    name: Build APK with Buildozer
    runs-on: ubuntu-22.04

    steps:
      # ── 1. Check out your repo ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ────────────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Cache Buildozer's heavy downloads (.buildozer dir) ───────────────
      - name: Cache Buildozer global directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      # ── 4. Install system-level dependencies ────────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update -y

          # libtinfo5 was dropped in Ubuntu 22.04; install libtinfo6 and
          # create the symlink that the Android NDK toolchain still looks for.
          sudo apt-get install -y libtinfo6
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libtinfo.so.6 \
                      /usr/lib/x86_64-linux-gnu/libtinfo.so.5 || true

          sudo apt-get install -y \
            git zip unzip wget \
            openjdk-17-jdk \
            python3-pip \
            autoconf automake libtool pkg-config \
            cmake ninja-build \
            zlib1g-dev \
            libncurses5-dev libncursesw5-dev \
            libffi-dev libssl-dev \
            build-essential libltdl-dev ccache \
            libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good \
            patchelf lld

      # ── 5. Set JAVA_HOME ────────────────────────────────────────────────────
      - name: Set JAVA_HOME
        run: echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      # ── 6. Install Python build tools ───────────────────────────────────────
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install buildozer cython==0.29.37

      # ── 7. Rename your script to main.py if needed ──────────────────────────
      #    If your entry point is already called main.py, delete this step.
      - name: Ensure entry point is main.py
        run: |
          if [ ! -f main.py ]; then
            # Rename whichever .py file contains PestRepellerApp().run()
            ENTRY=$(grep -rl "PestRepellerApp().run()" *.py | head -1)
            if [ -n "$ENTRY" ]; then
              cp "$ENTRY" main.py
              echo "Copied $ENTRY → main.py"
            else
              echo "ERROR: Could not find app entry point!" && exit 1
            fi
          fi

      # ── 8. Accept Android SDK licenses (non-interactive) ────────────────────
      - name: Accept Android SDK licenses
        run: |
          mkdir -p $HOME/.android
          touch $HOME/.android/repositories.cfg
          yes | buildozer android update 2>/dev/null || true

      # ── 9. Build the debug APK ───────────────────────────────────────────────
      - name: Build APK (debug)
        run: buildozer -v android debug
        env:
          ANDROID_SDK_ROOT: ${{ env.HOME }}/.buildozer/android/platform/android-sdk

      # ── 10. Upload the APK as a build artifact ───────────────────────────────
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: pest-repeller-debug-apk
          # Buildozer puts the APK in bin/
          path: bin/*.apk
          retention-days: 30

      # ── (Optional) Build release APK ─────────────────────────────────────────
      # Uncomment the block below if you want a signed release build.
      # You'll need to add KEYSTORE_FILE, KEY_ALIAS, KEY_PASSWORD,
      # and STORE_PASSWORD as GitHub repository secrets first.
      #
      # - name: Build APK (release)
      #   run: buildozer -v android release
      #
      # - name: Sign APK
      #   run: |
      #     echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > keystore.jks
      #     $ANDROID_SDK_ROOT/build-tools/*/apksigner sign \
      #       --ks keystore.jks \
      #       --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
      #       --ks-pass pass:"${{ secrets.STORE_PASSWORD }}" \
      #       --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
      #       bin/*-release-unsigned.apk
      #
      # - name: Upload signed release APK
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: pest-repeller-release-apk
      #     path: bin/*-release.apk
