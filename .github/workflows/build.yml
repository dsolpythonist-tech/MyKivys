name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK with Buildozer
    runs-on: ubuntu-22.04

    steps:
      # ── 1. Check out your repo ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ────────────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Cache Buildozer's heavy downloads (.buildozer dir) ───────────────
      - name: Cache Buildozer global directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      # ── 4. Install system-level dependencies ────────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libtinfo6
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libtinfo.so.6 \
                      /usr/lib/x86_64-linux-gnu/libtinfo.so.5 2>/dev/null || true
          sudo apt-get install -y libunwind-dev
          sudo apt-get install -y \
            git zip unzip wget \
            openjdk-17-jdk \
            python3-pip \
            autoconf automake libtool pkg-config \
            cmake ninja-build \
            zlib1g-dev \
            libncurses5-dev libncursesw5-dev \
            libffi-dev libssl-dev \
            build-essential libltdl-dev ccache \
            libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good \
            patchelf lld

      # ── 5. Set JAVA_HOME ────────────────────────────────────────────────────
      - name: Set JAVA_HOME
        run: |
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      # ── 6. Install Python build tools ───────────────────────────────────────
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install "cython<3" buildozer

      # ── 7. Debug: List all files in the repo ────────────────────────────────
      - name: List repository contents
        run: |
          echo "=== Files in repository root ==="
          ls -la
          echo ""
          echo "=== All Python files ==="
          find . -name "*.py" -type f

      # ── 8. Ensure entry point is main.py ────────────────────────────────────
      - name: Ensure entry point is main.py
        run: |
          # If main.py already exists, we're good
          if [ -f main.py ]; then
            echo "✓ main.py found"
            exit 0
          fi
          
          # Otherwise, try to find the app entry point
          echo "main.py not found, searching for entry point..."
          
          # Look for the app class instantiation
          ENTRY=$(find . -maxdepth 1 -name "*.py" -type f -exec grep -l "PestRepellerApp().run()" {} \; | head -1)
          
          if [ -n "$ENTRY" ]; then
            echo "Found entry point: $ENTRY"
            cp "$ENTRY" main.py
            echo "✓ Copied $ENTRY to main.py"
          else
            echo "ERROR: No Python file with PestRepellerApp().run() found!"
            echo "Please ensure your main Python file is in the repository root."
            echo ""
            echo "Available Python files:"
            find . -maxdepth 1 -name "*.py" -type f
            exit 1
          fi

      # ── 9. Initialize buildozer (downloads SDK) ──────────────────────────────
      - name: Initialize Buildozer
        run: |
          # This command makes buildozer download the Android SDK/NDK
          # but doesn't start the actual build yet
          buildozer android update 2>&1 | tee init.log || true
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2048m"

      # ── 10. Accept SDK licenses AFTER SDK is downloaded ──────────────────────
      - name: Accept Android SDK licenses
        run: |
          mkdir -p $HOME/.android
          touch $HOME/.android/repositories.cfg
          
          # The SDK should now exist. Accept licenses using sdkmanager.
          SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          
          if [ -d "$SDK_ROOT" ]; then
            echo "SDK found at: $SDK_ROOT"
            
            # Find sdkmanager (it's in cmdline-tools or tools/bin)
            SDKMANAGER=""
            if [ -f "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
              SDKMANAGER="$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
            elif [ -f "$SDK_ROOT/tools/bin/sdkmanager" ]; then
              SDKMANAGER="$SDK_ROOT/tools/bin/sdkmanager"
            fi
            
            if [ -n "$SDKMANAGER" ]; then
              echo "Using sdkmanager: $SDKMANAGER"
              yes | $SDKMANAGER --licenses || true
            else
              echo "sdkmanager not found, writing license hashes directly..."
              mkdir -p "$SDK_ROOT/licenses"
              printf "24333f8a63b6825ea9c5514f83c2829b004d1fee\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n" \
                > "$SDK_ROOT/licenses/android-sdk-license"
              printf "84831b9409646a918e30573bab4c9c91346d8abd\n504667f4c0de7af1a06de9f4b1727b84351f2910\n" \
                > "$SDK_ROOT/licenses/android-sdk-preview-license"
            fi
          else
            echo "WARNING: SDK not found yet, will rely on buildozer.spec settings"
          fi

      # ── 11. Build the debug APK ──────────────────────────────────────────────
      - name: Build APK (debug)
        run: |
          buildozer -v android debug 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}
        env:
          ANDROID_SDK_ROOT: /home/runner/.buildozer/android/platform/android-sdk
          ANDROID_NDK_HOME: /home/runner/.buildozer/android/platform/android-ndk-r25b
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2048m"

      # ── 12. Upload APK artifact ──────────────────────────────────────────────
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pest-repeller-debug-apk
          path: bin/*.apk
          retention-days: 30

      # ── 13. Always upload build logs ─────────────────────────────────────────
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            init.log
          retention-days: 7
