name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK with Buildozer
    runs-on: ubuntu-22.04

    steps:
      # ── 1. Check out your repo ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ────────────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Cache Buildozer's heavy downloads (.buildozer dir) ───────────────
      - name: Cache Buildozer global directory
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      # ── 4. Install system-level dependencies ────────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update -y

          # libtinfo5 is gone on Ubuntu 22.04 — install v6 and symlink for NDK
          sudo apt-get install -y libtinfo6
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libtinfo.so.6 \
                      /usr/lib/x86_64-linux-gnu/libtinfo.so.5 2>/dev/null || true

          # libunwind-dev must come before gstreamer (unmet dep otherwise)
          sudo apt-get install -y libunwind-dev

          sudo apt-get install -y \
            git zip unzip wget \
            openjdk-17-jdk \
            python3-pip \
            autoconf automake libtool pkg-config \
            cmake ninja-build \
            zlib1g-dev \
            libncurses5-dev libncursesw5-dev \
            libffi-dev libssl-dev \
            build-essential libltdl-dev ccache \
            libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good \
            patchelf lld

      # ── 5. Set JAVA_HOME ────────────────────────────────────────────────────
      - name: Set JAVA_HOME
        run: |
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      # ── 6. Install Python build tools ───────────────────────────────────────
      # IMPORTANT: python-for-android recipes break with Cython 3+. Pin to <3.
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install "cython<3" buildozer

      # ── 7. Ensure entry point is main.py ────────────────────────────────────
      - name: Ensure entry point is main.py
        run: |
          if [ ! -f main.py ]; then
            ENTRY=$(grep -rl "PestRepellerApp().run()" *.py | head -1)
            if [ -n "$ENTRY" ]; then
              cp "$ENTRY" main.py
              echo "Copied $ENTRY to main.py"
            else
              echo "ERROR: Could not find app entry point!" && exit 1
            fi
          fi

      # ── 8. Pre-write Android SDK license hashes ─────────────────────────────
      # Writing hashes directly avoids the interactive pipe that races in CI
      - name: Accept Android SDK licenses
        run: |
          mkdir -p $HOME/.android
          touch $HOME/.android/repositories.cfg

          SDK_LICENSES=$HOME/.buildozer/android/platform/android-sdk/licenses
          mkdir -p "$SDK_LICENSES"

          printf "24333f8a63b6825ea9c5514f83c2829b004d1fee\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n" \
            > "$SDK_LICENSES/android-sdk-license"
          printf "84831b9409646a918e30573bab4c9c91346d8abd\n504667f4c0de7af1a06de9f4b1727b84351f2910\n" \
            > "$SDK_LICENSES/android-sdk-preview-license"
          printf "601085b94cd77f0b54ff86406957099ebe79c4d6\n" \
            > "$SDK_LICENSES/android-googletv-license"
          printf "d975f751698a77b662f1254ddbeed3901e976f5a\n" \
            > "$SDK_LICENSES/intel-android-extra-license"

      # ── 9. Build the debug APK ───────────────────────────────────────────────
      - name: Build APK (debug)
        run: |
          buildozer -v android debug 2>&1 | tee build.log
          exit ${PIPESTATUS[0]}
        env:
          ANDROID_SDK_ROOT: /home/runner/.buildozer/android/platform/android-sdk
          ANDROID_NDK_HOME: /home/runner/.buildozer/android/platform/android-ndk-r25b

      # ── 10. Upload APK artifact ──────────────────────────────────────────────
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pest-repeller-debug-apk
          path: bin/*.apk
          retention-days: 30

      # ── 11. Always upload the full build log ─────────────────────────────────
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
